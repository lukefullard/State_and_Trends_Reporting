<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>stlite app</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css"
    />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
stlite.mount(
  {
    requirements: ["unidecode", "openpyxl", "plotly"],
    entrypoint: "streamlit_app.py",
    files: {
"streamlit_app.py": `import streamlit as st
import json
import pyodide.http
from PIL import Image
from io import BytesIO

############################################ 
from functions import load_url, load_settings, load_page_setup, load_sidebar_image, load_colourblind_checkbox, load_plotting_checkbox, load_datatable_checkbox
############################################
def initialise_session_state():    
    state_variables = ['current_page', 'settings',
    'current_page','current_site','current_site_data',
    'sidebar_image','plot_mode','data_table_mode',
    'filtered_sites','site_user_choice',
    'colourblind_mode','colourblind_colours',
    'second_site','site2_user_choice','site2_data',
    'reverse_2nd_axis','log_check']
    for variable_i in state_variables:
        if variable_i not in st.session_state:
            st.session_state[variable_i] = None
############################################
load_page_setup()

#initialise session state
initialise_session_state()

#load sidebar    
if not st.session_state['sidebar_image']:
    await load_sidebar_image()
st.sidebar.image(Image.open(BytesIO(st.session_state['sidebar_image'])))    

#load settings
if not st.session_state['settings']:
    await load_settings() 

#load colourblind checkbox
load_colourblind_checkbox()
#load plotting checkbox
load_plotting_checkbox()
#load datatable checkbox
load_datatable_checkbox()

#text
st.title('Welcome to State View')
st.write('To get started, choose a page on the sidebar.')
st.write('---')
st.title('DISCLAIMER')
st.write('''
The enclosed information is supplied, within the framework of our quality system, from the best data currently available.
However, as we endeavour to continuously improve our products, we reserve the right to amend the data on which this information is based, where necessary and without notice, at any time. As a result, the information supplied to you now may not be the same as that subsequently produced for you or any other client.

While Manawatū-Whanganui Regional Council has exercised all reasonable skill and care in controlling the contents of the information, you should independently check the information provided if the accuracy of that information is important to you.
Under no circumstances will the Manawatū-Whanganui Regional Council or its employees or agents be liable in contract, tort or otherwise to compensate you for any loss, injury or damage (including loss of profits or consequential loss) arising directly or indirectly from the supply by the Council or its agents of inadequate, inaccurate or incorrect information.

Manawatū-Whanganui Regional Council is the owner of the copyright subsisting in the enclosed material unless otherwise specified. Copies of the enclosed material, or any part thereof, by any means whatsoever shall be made only for use by you as the client for your own internal purposes and shall not be conveyed to any third party or merged into another machine readable database without the express permission of the Council.
Any use of the material supplied, for example, by inclusion in a report or a media release, should be accompanied by an acknowledgment of the source of the data.

Your acceptance of the enclosed material and/or services signifies your acceptance of these terms and conditions.
''')


############################################

`,
"pages/Rivers.py": `import streamlit as st
import json
import pyodide.http
from PIL import Image
from io import BytesIO
import pandas as pd
from plotting_functions import grade_time_plot, grade_time_plot_2_sites, scatter_plot, scatter_plot_2_sites, scatter_plot_2variables 

############################################  
from functions import load_url,clean_text,get_data_links,load_colourblind_checkbox, load_plotting_checkbox, load_datatable_checkbox, load_second_site_checkbox, load_reverse_second_axis_checkbox, load_log_checkbox
############################################
###############################################################################
############################################
def choose_spatial_area():
    spatial_area_names = list(list(st.session_state['site_list'].values())[0].keys())
    spatial_user_choice = st.radio('How would you like to select your sites? By: ',['All sites'] + spatial_area_names)
    return spatial_user_choice
############################################
def choose_sub_spatial_area(spatial_user_choice,sub_spatial_areas):
    sub_spatial_user_choice = st.selectbox(f'Please choose a {spatial_user_choice}: ',['Please select one'] + sub_spatial_areas)
    return sub_spatial_user_choice    
############################################
def choose_site_of_interest(site_list):
    site_user_choice = st.selectbox('Please choose a site: ',['Please select one'] + site_list)
    return site_user_choice        
############################################
def choose_coparison_site(site_list):
    site2_user_choice = st.selectbox('Please choose a second site: ',['Please select one'] + [x for x in site_list if x != st.session_state['site_user_choice']])
    return site2_user_choice 
############################################
def choose_attribute(attribute_list,text = 'Please choose an attribute to plot: '):
    attribute_user_choice = st.selectbox(text,['Please select one'] + attribute_list)
    return attribute_user_choice  
def choose_attribute_2(attribute_list,text = 'If desired, please choose a second attribute to plot: '):
    attribute_user_choice = st.selectbox(text,['Please select one'] + attribute_list)
    return attribute_user_choice     
############################################
############################################
############################################
############################################
############################################
############################################
# main 
#load sidebar image
st.sidebar.image(Image.open(BytesIO(st.session_state['sidebar_image'])))
#load colourblind checkbox
load_colourblind_checkbox()
#load plotting checkbox
load_plotting_checkbox()
#load datatable checkbox
load_datatable_checkbox()

#load site list
if st.session_state['current_page'] != 'Rivers':
    url = st.session_state['settings'].get('pages').get('Rivers')
    sites = await load_url(url,text=True)
    st.session_state['site_list'] = json.loads(sites.encode().decode('utf-8-sig'))
    
#update current page
st.session_state['current_page'] = 'Rivers'

#write intro message
st.write('---')
st.write("**Welcome** to the rivers state results.") 
st.write('---')

#choose spatial area
spatial_user_choice = choose_spatial_area()
st.write('---')
if spatial_user_choice == 'All sites':
    sub_spatial_user_choice = 'N/A'
    st.session_state['filtered_sites'] = sorted(list(st.session_state['site_list'].keys()))
else:
    sub_regions = sorted(list(set([x.get(spatial_user_choice) for x in st.session_state['site_list'].values()])))
    sub_spatial_user_choice = choose_sub_spatial_area(spatial_user_choice,sub_regions)
    if sub_spatial_user_choice != 'Please select one':
        st.session_state['filtered_sites'] = sorted([x for x in st.session_state['site_list'].keys() if st.session_state['site_list'].get(x).get(spatial_user_choice) == sub_spatial_user_choice])

# choose site of interest    
if (st.session_state['filtered_sites'] is not None) and (sub_spatial_user_choice != 'Please select one'):
    st.session_state['site_user_choice']  =  choose_site_of_interest(st.session_state['filtered_sites']) 
    st.write('---')  

# display state and raw data link     
if st.session_state['site_user_choice'] not in [None,'Please select one']:
    st.subheader('Data downloads')
    state_data_link,raw_data_link  =  get_data_links(topic = 'Rivers')
    col1,col2 = st.columns(2)
    with col1:
        place_holder_1 = st.empty()
        place_holder_1.write(f"|--Download **STATE** data for [**{st.session_state['site_user_choice']}**]({state_data_link})--|")
    with col2:
        place_holder_2 = st.empty()
        place_holder_2.write(f"|--Download **RAW** data for [**{st.session_state['site_user_choice']}**]({raw_data_link})--|")
    st.write('---')    
 
    #load site data
    if st.session_state['current_site'] != st.session_state['site_user_choice']:
        url = state_data_link
        site_data_in_bytes = await load_url(url,text=False)
        try:st.session_state['current_site_data'] = pd.read_csv(BytesIO(site_data_in_bytes))
        except:st.session_state['current_site_data'] = pd.read_excel(BytesIO(site_data_in_bytes))
        st.session_state['current_site'] = st.session_state['site_user_choice']
        

st.markdown("""
        <style>
                .stPlotlyChart {
                    height: 90vh !important;
                            }
        </style>
        """, unsafe_allow_html=True)

#plot grade_time_plot
if (st.session_state['current_site'] == st.session_state['site_user_choice']) & (st.session_state['current_site_data'] is not None) & (st.session_state['plot_mode']):
    st.subheader('Figures')
    col_0,col_1 = st.columns(2)
    col_0.write('**NOF grades over time**')
    with col_1:
        load_second_site_checkbox()

    if st.session_state['second_site']:
        with col_1:
            st.session_state['site2_user_choice']  = choose_coparison_site(st.session_state['filtered_sites'])
            if st.session_state['site2_user_choice'] != 'Please select one':
                state2_data_link,raw2_data_link  =  get_data_links(topic = 'Rivers', site2 = True)
                url = state2_data_link
                site2_data_in_bytes = await load_url(url,text=False)
                try:st.session_state['site2_data'] = pd.read_csv(BytesIO(site2_data_in_bytes))
                except:st.session_state['site2_data'] = pd.read_excel(BytesIO(site2_data_in_bytes))
        if (st.session_state['site2_data'] is not None) and (st.session_state['site2_user_choice'] != 'Please select one'):
            place_holder_1.write(f'''
|--Download **STATE** data for [**{st.session_state['site_user_choice']}**]({state_data_link})--|   

|--Download **STATE** data for [**{st.session_state['site2_user_choice']}**]({state2_data_link})--|            
            ''')
            place_holder_2.write(f'''
|--Download **RAW** data for [**{st.session_state['site_user_choice']}**]({raw_data_link})--|   

|--Download **RAW** data for [**{st.session_state['site2_user_choice']}**]({raw2_data_link})--|
            ''')            
            with col_1:
                load_reverse_second_axis_checkbox()
            st.plotly_chart(grade_time_plot_2_sites(st.session_state['current_site_data'],
                        st.session_state['site2_data'],
                        topic='Rivers'),
                        use_container_width = True)   
        
        
        if (st.session_state['site2_data'] is not None) and (st.session_state['site2_user_choice'] != 'Please select one'):
            st.write('**NOF Grade scatterplot**')
            user_attribute = choose_attribute(sorted(list(st.session_state['current_site_data']['attribute type'].unique())),text = f'Please choose an attribute to plot at {st.session_state["site_user_choice"]}: ' )
            user_attribute_site_2 = choose_attribute(sorted(list(st.session_state['site2_data']['attribute type'].unique())),text = f'Please choose an attribute to plot at {st.session_state["site2_user_choice"]}: ' )
            if (user_attribute not in [None,"Please select one"]) and (user_attribute_site_2 in [None,"Please select one"]):       
                load_log_checkbox()
                st.plotly_chart(scatter_plot(st.session_state['current_site_data'].loc[st.session_state['current_site_data']['attribute type'] == user_attribute].reset_index(drop=True), 
                    user_attribute, data_column = st.session_state['settings'].get('nof_attribute_statistics').get(user_attribute),topic='Rivers', sitename = st.session_state['site_user_choice']),
                    use_container_width = True)  
            if (user_attribute in [None,"Please select one"]) and (user_attribute_site_2 not in [None,"Please select one"]):       
                load_log_checkbox()
                st.plotly_chart(scatter_plot(st.session_state['site2_data'].loc[st.session_state['site2_data']['attribute type'] == user_attribute_site_2].reset_index(drop=True), 
                    user_attribute_site_2, data_column = st.session_state['settings'].get('nof_attribute_statistics').get(user_attribute_site_2),topic='Rivers', sitename = st.session_state['site2_user_choice'], markersymbol = 'triangle-down'),
                    use_container_width = True)                 
            if (user_attribute not in [None,"Please select one"]) and (user_attribute_site_2 not in [None,"Please select one"]):   
                load_log_checkbox()
                st.plotly_chart(scatter_plot_2_sites(st.session_state['current_site_data'].loc[st.session_state['current_site_data']['attribute type'] == user_attribute].reset_index(drop=True),st.session_state['site2_data'].loc[st.session_state['site2_data']['attribute type'] == user_attribute_site_2].reset_index(drop=True), 
                    user_attribute, user_attribute_site_2, 
                    data_column0 = st.session_state['settings'].get('nof_attribute_statistics').get(user_attribute), data_column1 = st.session_state['settings'].get('nof_attribute_statistics').get(user_attribute_site_2),topic='Rivers', 
                    sitename0 = st.session_state['site_user_choice'], sitename1 = st.session_state['site2_user_choice']),
                    use_container_width = True)          

    
    else:
        c0,c1,c2 = st.columns([1,8,1])
        c1.plotly_chart(grade_time_plot(st.session_state['current_site_data'],topic='Rivers'),
                        use_container_width = True)        
        c0.write('---')
        c1.write('---')
        c2.write('---')


        with c1:
            st.write('**NOF Grade scatterplot**')
            user_attribute = choose_attribute(sorted(list(st.session_state['current_site_data']['attribute type'].unique())))
            user_attribute_2 = choose_attribute_2(sorted(list([x for x in st.session_state['current_site_data']['attribute type'].unique() if x != user_attribute])))
            if (user_attribute not in [None,"Please select one"]) & (user_attribute_2 in [None,"Please select one"]):
                load_log_checkbox()
                st.plotly_chart(scatter_plot(st.session_state['current_site_data'].loc[st.session_state['current_site_data']['attribute type'] == user_attribute].reset_index(drop=True), 
                    user_attribute, data_column = st.session_state['settings'].get('nof_attribute_statistics').get(user_attribute),topic='Rivers', sitename = st.session_state['site_user_choice']),
                    use_container_width = True)
            if (user_attribute not in [None,"Please select one"]) & (user_attribute_2 not in [None,"Please select one"]):
                load_log_checkbox()
                st.plotly_chart(scatter_plot_2variables(st.session_state['current_site_data'].loc[st.session_state['current_site_data']['attribute type'].isin([user_attribute,user_attribute_2])].reset_index(drop=True), 
                    user_attribute,user_attribute_2, 
                    data_column1 = st.session_state['settings'].get('nof_attribute_statistics').get(user_attribute),
                    data_column2 = st.session_state['settings'].get('nof_attribute_statistics').get(user_attribute_2),
                    topic='Rivers', sitename = st.session_state['site_user_choice']),
                    use_container_width = True)         
    st.write('---')




# show data
if (st.session_state['current_site'] == st.session_state['site_user_choice']) & (st.session_state['current_site_data'] is not None) & (st.session_state['data_table_mode']):
    st.write('---') 
    st.subheader('Data table')
    st.dataframe(st.session_state['current_site_data'],
                hide_index=True)`,
"functions.py": `import streamlit as st
import json
import pyodide.http
from PIL import Image
from io import BytesIO

##########################################
##########################################
##########################################
def load_page_setup():
    #load the page config
    st.set_page_config( 
        page_title="State View",
        layout="wide",
        initial_sidebar_state="expanded"
        ) 
def load_colourblind_checkbox():
    colourblind_check = st.sidebar.checkbox('Use colourblind mode',value = st.session_state['colourblind_mode'])
    if colourblind_check:
        st.session_state['colourblind_colours'] =  st.session_state['settings'].get('nof_grade_colourblind_colours')
        st.session_state['colourblind_mode'] = True
    else:
        st.session_state['colourblind_colours'] =  st.session_state['settings'].get('nof_grade_colours')
        st.session_state['colourblind_mode'] = False

def load_plotting_checkbox():
    colourblind_check = st.sidebar.checkbox('Plot figures?',value = st.session_state['plot_mode'])
    if colourblind_check:
        st.session_state['plot_mode'] = True
    else:
        st.session_state['plot_mode'] = False

def load_datatable_checkbox():
    colourblind_check = st.sidebar.checkbox('Show data table?',value = st.session_state['data_table_mode'])
    if colourblind_check:
        st.session_state['data_table_mode'] = True
    else:
        st.session_state['data_table_mode'] = False  

def load_second_site_checkbox():
    second_site = st.checkbox('Compare a second site?',value = st.session_state['second_site'])
    if second_site:
        st.session_state['second_site'] = True
    else:
        st.session_state['second_site'] = False   

def load_reverse_second_axis_checkbox():
    second_axis = st.checkbox('Reverse the second axis?',value = st.session_state['reverse_2nd_axis'])
    if second_axis:
        st.session_state['reverse_2nd_axis'] = True
    else:
        st.session_state['reverse_2nd_axis'] = False   

def load_log_checkbox():
    log_check = st.checkbox('Plot the y-axis on a log scale?',value = st.session_state['log_check'])
    if log_check:
        st.session_state['log_check'] = True
    else:
        st.session_state['log_check'] = False          
              
##########################################
##########################################
##########################################
async def load_url(url,text=True):
    response = await pyodide.http.pyfetch(url)
    if text:
        data = await response.string()
    else:
        data = await response.bytes()
    return data   
##########################################
##########################################
##########################################    
async def load_sidebar_image(): 
    url = r'https://raw.githubusercontent.com/lukefullard/State_and_Trends_Reporting/main/assets/SidebarTitle.png'
    sidebar_image = await load_url(url,text=False) 
    st.session_state['sidebar_image'] = sidebar_image         
##########################################
##########################################
##########################################
async def load_settings(): 
    url = r'https://raw.githubusercontent.com/lukefullard/State_and_Trends_Reporting/main/scripts_and_settings/app_settings.json'
    data = await load_url(url,text=True)
    st.session_state['settings'] = json.loads(data)
##########################################
##########################################
##########################################
def clean_text(text, add_hash = False):
    '''
    Convenience function to clean text by removing unicode characters (such as macrons) and non-alpha-numeric characters (spaces, punctuation, symbols etc)

    Parameters
    ----------
    text : string
        DESCRIPTION: String to clean
        
    add_hash : Boolean, optional
        DESCRIPTION: The default is False. If True, adds an underscore + a hash to the text (to ensure uniqueness after cleaning).     

    Returns
    -------
    cleaned_text : string
        DESCRIPTION: cleaned string

    '''
    import unidecode
    cleaned_text = unidecode.unidecode(text)
    cleaned_text = ''.join(e for e in cleaned_text if e.isalnum())
    
    if add_hash:
        import hashlib 
        cleaned_text = cleaned_text + '_' + str(hashlib.shake_256(text.encode()).hexdigest(5))
    return cleaned_text

##########################################
##########################################
##########################################
def get_data_links(topic = 'Rivers', site2 = False):
    if site2:
        cleaned_site_name = clean_text(st.session_state['site2_user_choice'], add_hash = True)
        state_data_link = st.session_state['settings'].get('state_data') + 'Rivers/' +cleaned_site_name + '.xlsx'
        raw_data_link = st.session_state['settings'].get('raw_data') + topic + '/' + cleaned_site_name + '.xlsx'    
    else:
        cleaned_site_name = clean_text(st.session_state['site_user_choice'], add_hash = True)
        state_data_link = st.session_state['settings'].get('state_data') + 'Rivers/' +cleaned_site_name + '.xlsx'
        raw_data_link = st.session_state['settings'].get('raw_data') + topic + '/' + cleaned_site_name + '.xlsx'
    return state_data_link,raw_data_link

##########################################
##########################################
##########################################


##########################################
##########################################
##########################################


##########################################
##########################################
##########################################`,
"plotting_functions.py": `import streamlit as st
import copy
import pandas as pd



def grade_time_plot(data,topic='Rivers'):
    year_list = sorted(list(data['year range'].unique()))
    first_year = int(year_list[0][0:4])
    last_year = int(year_list[-1][0:4])
    final_year_list = [f"{x} - {x+4}" for x in range(first_year,last_year+1)]
    #st.write(final_year_list)

    copydata = copy.deepcopy(data)
    copydata = copydata.sort_values(by = ['year range','attribute type'],ascending = True)
    import plotly.express as px
    fig = px.scatter(copydata, x='year range', y='attribute type', color="NOF_Grade",
                  hover_data="NOF_Grade", text = "NOF_Grade",
                  color_discrete_map = st.session_state['colourblind_colours'],
                  category_orders={"NOF_Grade": list(st.session_state['colourblind_colours'].keys()),
                  "year range": final_year_list
                  },
                  title = f"{st.session_state['current_site']}",
                  )
    fig.update_traces(marker_size   =18, 
                     marker_opacity = 0.7,
                     marker_symbol  = 'square')  
    fig.update_layout(yaxis_title='')
    fig.update_layout(xaxis_title='')           
    fig.update_layout(legend_title_text='')    
    
    
    attributes = sorted(list(copydata['attribute type'].unique()))
    final_attributes = [x for x in attributes if x in st.session_state['settings'].get('nof_band_definitions').get(topic).keys()]
    fig.update_yaxes(categoryorder='array', categoryarray=final_attributes )  
    
    fig.update_layout(plot_bgcolor="#ededed")
    fig.update_yaxes(showgrid=True, gridwidth=2, gridcolor='white')
    #fig.update_layout(
    #autosize=False,
    #height=100+35*len(final_attributes),
    #width = 50 + 35*len(list(copydata['year range'].unique()))
    #)
    return fig 

###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################

def grade_time_plot_2_sites(data1,data2,topic='Rivers'):
    
    final_data = copy.deepcopy(data2)
    final_data = pd.concat([final_data,data1],ignore_index = True).reset_index(drop=True)
    year_list = sorted(list(final_data['year range'].unique()))
    first_year = int(year_list[0][0:4])
    last_year = int(year_list[-1][0:4])
    final_year_list = [f"{x} - {x+4}" for x in range(first_year,last_year+1)]


    copydata = copy.deepcopy(final_data)
    copydata = copydata.sort_values(by = ['year range','attribute type'],ascending = True)
    import plotly.express as px
    fig = px.scatter(copydata, x='year range', y='attribute type', color="NOF_Grade",
                  hover_data="NOF_Grade", text = "NOF_Grade",
                  color_discrete_map = st.session_state['colourblind_colours'],
                  category_orders={"NOF_Grade": list(st.session_state['colourblind_colours'].keys()),
                  "year range": final_year_list,
                  "site name": [st.session_state['site_user_choice'],st.session_state['site2_user_choice']]
                  },
                  #title = f"{st.session_state['current_site']}",
                  facet_col="site name"
                  )
    if st.session_state['reverse_2nd_axis']:              
        fig.update_xaxes(matches=None)    
        fig.update_xaxes(categoryarray = list(reversed(final_year_list)),categoryorder = "array",col = 2)                  

    
    fig.for_each_annotation(lambda a: a.update(text=a.text.split("=")[-1]))                  
    fig.update_annotations(font=dict(size=16,color='black'))
    fig.update_traces(marker_size   =18, 
                     marker_opacity = 0.7,
                     marker_symbol  = 'square')  
    fig.update_layout(yaxis_title='')
    fig.update_layout(xaxis_title='')           
    fig.update_layout(legend_title_text='')    
    
    
    attributes = sorted(list(copydata['attribute type'].unique()))
    final_attributes = [x for x in attributes if x in st.session_state['settings'].get('nof_band_definitions').get(topic).keys()]
    fig.update_yaxes(categoryorder='array', categoryarray=final_attributes )  
    
    fig.update_layout(plot_bgcolor="#ededed")
    fig.update_yaxes(showgrid=True, gridwidth=2, gridcolor='white')
    #fig.update_layout(
    #autosize=False,
    #height=100+35*len(final_attributes),
    #width = 50 + 35*len(list(copydata['year range'].unique()))
    #)
    return fig     

###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################


def scatter_plot(data, attribute_name, data_column = 'Median',topic='Rivers', sitename = st.session_state['current_site'], markersymbol = 'triangle-up'):
    year_list = sorted(list(data['year range'].unique()))
    first_year = int(year_list[0][0:4])
    last_year = int(year_list[-1][0:4])
    final_year_list = [f"{x} - {x+4}" for x in range(first_year,last_year+1)]

    

    copydata = copy.deepcopy(data)
    copydata = copydata.sort_values(by = ['year range','attribute type'],ascending = True)
    if st.session_state['log_check']:
        min_y = 0.975*min(copydata[data_column])
    else:
        min_y = 0
    max_y = 1.025*max(copydata[data_column])
    import plotly.express as px
    fig = px.scatter(copydata, x='year range', y=data_column, 
                  color="site name",
                  hover_data="NOF_Grade", text = "NOF_Grade",
                  title = sitename,
                  color_discrete_map = {sitename: "black"},
                  log_y = st.session_state['log_check'],
                  range_y = [min_y,max_y],
                  )
    fig.update_traces(marker_size   =22, 
                     marker_opacity = 0.7,
                     marker_symbol  = markersymbol,
                     textfont_color = 'white')  
    fig.update_layout(yaxis_title=f"{attribute_name} ({st.session_state['settings'].get('nof_attribute_statistics').get(attribute_name)}, {st.session_state['settings'].get('nof_attribute_units').get(attribute_name)})")
    fig.update_layout(xaxis_title='')           
    fig.update_layout(legend_title_text='')    

    fig.update_layout(plot_bgcolor="#ededed")
    fig.update_yaxes(showgrid=True, gridwidth=2, gridcolor='white')

    #adding background colours
    if (st.session_state['settings'].get('add_nof_grade_background_colours')) and (st.session_state['settings'].get('nof_band_definitions').get(topic).get(attribute_name)):
        current_band_definitions = st.session_state['settings'].get('nof_band_definitions').get(topic).get(attribute_name)
        for iter_j,label_j in  enumerate(current_band_definitions.get('labels')):
            current_colour = st.session_state['colourblind_colours'].get(label_j)
            y0 = current_band_definitions.get('bins')[iter_j]
            y1 = min(current_band_definitions.get('bins')[iter_j+1], 1.025*max(copydata[data_column]))    
            fig.add_hrect(y0=y0, y1=y1, line_width=0, fillcolor=current_colour, opacity=0.4)

    #adding custom legend
    import plotly.graph_objects as go
    if not topic == "Contact Rec":
        fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="A",
                                marker=dict(size=7, color=st.session_state['colourblind_colours'].get('A'), symbol='square'),),)
        fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="B",
                                marker=dict(size=7, color=st.session_state['colourblind_colours'].get('B'), symbol='square'),),)                        
        fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="C",
                                marker=dict(size=7, color=st.session_state['colourblind_colours'].get('C'), symbol='square'),),)
        fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="D",
                                marker=dict(size=7, color=st.session_state['colourblind_colours'].get('D'), symbol='square'),),)                                                
        if "E coli" in attribute_name:
            fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="E",
                                marker=dict(size=7, color=st.session_state['colourblind_colours'].get('E'), symbol='square'),),)

                    
    return fig 

###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################


def scatter_plot_2variables(data, attribute_name1,attribute_name2, data_column1 = 'Median',data_column2 = 'Median',topic='Rivers', sitename = st.session_state['current_site'], markersymbol1 = 'triangle-up', markersymbol2 = 'triangle-down'):
    year_list = sorted(list(data['year range'].unique()))
    first_year = int(year_list[0][0:4])
    last_year = int(year_list[-1][0:4])
    final_year_list = [f"{x} - {x+4}" for x in range(first_year,last_year+1)]

    final_data_column = []
    for iter_j,row_j in data.iterrows():
        if row_j['attribute type'] == attribute_name1:
            final_data_column.append(row_j[data_column1])
        if row_j['attribute type'] == attribute_name2:
            final_data_column.append(row_j[data_column2])    
    data['final_data_column'] = final_data_column        
    
    

    copydata = copy.deepcopy(data)
    copydata = copydata.sort_values(by = ['year range','attribute type'],ascending = True)
    if st.session_state['log_check']:
        min_y = 0.975*min(copydata['final_data_column'])
    else:
        min_y = 0
    max_y = 1.025*max(copydata['final_data_column'])
    import plotly.express as px
    fig = px.scatter(copydata, x='year range', y='final_data_column', 
                  color="attribute type",
                  hover_data="NOF_Grade", text = "NOF_Grade",
                  title = f"{sitename}: {attribute_name1} -- and -- {attribute_name2}",
                  color_discrete_map = {attribute_name1: "black", attribute_name2 : 'mediumpurple'},
                  log_y = st.session_state['log_check'],
                  range_y = [min_y,max_y],
                  symbol = "attribute type",
                  symbol_map = {attribute_name1: markersymbol1, attribute_name2: markersymbol2},
                  )
    fig.update_traces(marker_size   =22, 
                     marker_opacity = 0.7,
                     textfont_color = 'white')  
    fig.update_layout(yaxis_title='')
    fig.update_layout(xaxis_title='')           
    fig.update_layout(legend_title_text='')    

    fig.update_layout(plot_bgcolor="#ededed")
    fig.update_yaxes(showgrid=True, gridwidth=2, gridcolor='white')
                
    return fig 




    ###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################


    ###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################
###########################################


def scatter_plot_2_sites(data0,data1, 
        attribute_name0, attribute_name1, 
        data_column0 = 'Median', data_column1 = 'Median',topic='Rivers', 
        sitename0 = '', sitename1 = '', 
        markersymbol0 = 'triangle-up', markersymbol1 = 'triangle-down'):
    
    data0['final_data_column'] = data0[data_column0]
    data1['final_data_column'] = data1[data_column1]

    final_data = copy.deepcopy(data0)
    final_data = pd.concat([final_data,data1],ignore_index = True).reset_index(drop=True)
    year_list = sorted(list(final_data['year range'].unique()))
    first_year = int(year_list[0][0:4])
    last_year = int(year_list[-1][0:4])
    final_year_list = [f"{x} - {x+4}" for x in range(first_year,last_year+1)]

    copydata = copy.deepcopy(final_data)
    copydata = copydata.sort_values(by = ['year range'],ascending = True)
    if st.session_state['log_check']:
        min_y = 0.975*min(copydata['final_data_column'])
    else:
        min_y = 0
    max_y = 1.025*max(copydata['final_data_column'])
    import plotly.express as px
    fig = px.scatter(copydata, x='year range', y='final_data_column', 
                  color="site name",
                  hover_data="NOF_Grade", text = "NOF_Grade",
                  symbol = "site name",
                  title = f"{sitename0} ({attribute_name0}) -- and -- {sitename1} ({attribute_name1})",
                  color_discrete_map = {sitename0: "black",sitename1: "black"},
                  symbol_map = {sitename0: markersymbol0, sitename1: markersymbol1},
                  log_y = st.session_state['log_check'],
                  range_y = [min_y,max_y],
                  category_orders={
                  "year range": final_year_list,
                  },
                  )
    fig.update_traces(marker_size   =22, 
                     marker_opacity = 0.7,
                     #marker_symbol  = markersymbol,
                     textfont_color = 'white')  
    if attribute_name0 == attribute_name1:                 
        fig.update_layout(yaxis_title=f"{attribute_name0} ({st.session_state['settings'].get('nof_attribute_statistics').get(attribute_name0)}, {st.session_state['settings'].get('nof_attribute_units').get(attribute_name0)})")
    else:
        fig.update_layout(yaxis_title="")

    fig.update_layout(xaxis_title='')           
    fig.update_layout(legend_title_text='')    

    fig.update_layout(plot_bgcolor="#ededed")
    fig.update_yaxes(showgrid=True, gridwidth=2, gridcolor='white')

    #adding background colours
    if attribute_name0 == attribute_name1:
        if (st.session_state['settings'].get('add_nof_grade_background_colours')) and (st.session_state['settings'].get('nof_band_definitions').get(topic).get(attribute_name0)):
            current_band_definitions = st.session_state['settings'].get('nof_band_definitions').get(topic).get(attribute_name0)
            for iter_j,label_j in  enumerate(current_band_definitions.get('labels')):
                current_colour = st.session_state['colourblind_colours'].get(label_j)
                y0 = current_band_definitions.get('bins')[iter_j]
                y1 = min(current_band_definitions.get('bins')[iter_j+1], 1.025*max(copydata['final_data_column']))    
                fig.add_hrect(y0=y0, y1=y1, line_width=0, fillcolor=current_colour, opacity=0.4)

        #adding custom legend
        import plotly.graph_objects as go
        if not topic == "Contact Rec":
            fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="A",
                                    marker=dict(size=7, color=st.session_state['colourblind_colours'].get('A'), symbol='square'),),)
            fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="B",
                                    marker=dict(size=7, color=st.session_state['colourblind_colours'].get('B'), symbol='square'),),)                        
            fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="C",
                                    marker=dict(size=7, color=st.session_state['colourblind_colours'].get('C'), symbol='square'),),)
            fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="D",
                                    marker=dict(size=7, color=st.session_state['colourblind_colours'].get('D'), symbol='square'),),)                                                
            if "E coli" in attribute_name0:
                fig.add_trace(go.Scatter(x=[None],y=[None],mode="markers",name="E",
                                    marker=dict(size=7, color=st.session_state['colourblind_colours'].get('E'), symbol='square'),),)

                    
    return fig `,

},
  },
  document.getElementById("root")
)

    </script>
  </body>
  <!-- Generated from stlite sharing (https://edit.share.stlite.net/), and the source version is 82a4b24dc72ad76886dde43e3fbe47e24fb0eebe  # 82a4b24dc72ad76886dde43e3fbe47e24fb0eebe is available on GitHub Actions: https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables -->
</html>